#include <string.h>
#include <stdio.h>
#include <unistd.h>

#include "dvi.h"
#include "dvi_serialiser.h"
#include "common_dvi_pin_configs.h"
#include "tmds_encode.h"
#include "hardware/structs/bus_ctrl.h"
#include "hardware/vreg.h"
#include "hardware/irq.h"
#include "hardware/clocks.h"

#define VIDEO_FB_HRES           512
#define VIDEO_FB_VRES           342

#define FIRST_LINE (((FRAME_HEIGHT - VIDEO_FB_VRES) / 2) - 1)
#define LAST_LINE ((FIRST_LINE + VIDEO_FB_VRES) + 1)
#define HORIZONTAL_OFFSET ((FRAME_WIDTH - VIDEO_FB_HRES) / 16)

#define STRIDE (VIDEO_FB_HRES / 8)
#define FRAME_WIDTH 640
#define FRAME_HEIGHT 480
#define DVI_TIMING dvi_timing_640x480p_60hz
#define VREG_VSEL VREG_VOLTAGE_1_20

uint8_t* fb = NULL;

struct dvi_inst dvi0;


unsigned char table[] = {
        0x00 ^ 0xFF, 0x80 ^ 0xFF, 0x40 ^ 0xFF, 0xc0 ^ 0xFF, 0x20 ^ 0xFF, 0xa0 ^ 0xFF, 0x60 ^ 0xFF, 0xe0 ^ 0xFF,
        0x10 ^ 0xFF, 0x90 ^ 0xFF, 0x50 ^ 0xFF, 0xd0 ^ 0xFF, 0x30 ^ 0xFF, 0xb0 ^ 0xFF, 0x70 ^ 0xFF, 0xf0 ^ 0xFF,
        0x08 ^ 0xFF, 0x88 ^ 0xFF, 0x48 ^ 0xFF, 0xc8 ^ 0xFF, 0x28 ^ 0xFF, 0xa8 ^ 0xFF, 0x68 ^ 0xFF, 0xe8 ^ 0xFF,
        0x18 ^ 0xFF, 0x98 ^ 0xFF, 0x58 ^ 0xFF, 0xd8 ^ 0xFF, 0x38 ^ 0xFF, 0xb8 ^ 0xFF, 0x78 ^ 0xFF, 0xf8 ^ 0xFF,
        0x04 ^ 0xFF, 0x84 ^ 0xFF, 0x44 ^ 0xFF, 0xc4 ^ 0xFF, 0x24 ^ 0xFF, 0xa4 ^ 0xFF, 0x64 ^ 0xFF, 0xe4 ^ 0xFF,
        0x14 ^ 0xFF, 0x94 ^ 0xFF, 0x54 ^ 0xFF, 0xd4 ^ 0xFF, 0x34 ^ 0xFF, 0xb4 ^ 0xFF, 0x74 ^ 0xFF, 0xf4 ^ 0xFF,
        0x0c ^ 0xFF, 0x8c ^ 0xFF, 0x4c ^ 0xFF, 0xcc ^ 0xFF, 0x2c ^ 0xFF, 0xac ^ 0xFF, 0x6c ^ 0xFF, 0xec ^ 0xFF,
        0x1c ^ 0xFF, 0x9c ^ 0xFF, 0x5c ^ 0xFF, 0xdc ^ 0xFF, 0x3c ^ 0xFF, 0xbc ^ 0xFF, 0x7c ^ 0xFF, 0xfc ^ 0xFF,
        0x02 ^ 0xFF, 0x82 ^ 0xFF, 0x42 ^ 0xFF, 0xc2 ^ 0xFF, 0x22 ^ 0xFF, 0xa2 ^ 0xFF, 0x62 ^ 0xFF, 0xe2 ^ 0xFF,
        0x12 ^ 0xFF, 0x92 ^ 0xFF, 0x52 ^ 0xFF, 0xd2 ^ 0xFF, 0x32 ^ 0xFF, 0xb2 ^ 0xFF, 0x72 ^ 0xFF, 0xf2 ^ 0xFF,
        0x0a ^ 0xFF, 0x8a ^ 0xFF, 0x4a ^ 0xFF, 0xca ^ 0xFF, 0x2a ^ 0xFF, 0xaa ^ 0xFF, 0x6a ^ 0xFF, 0xea ^ 0xFF,
        0x1a ^ 0xFF, 0x9a ^ 0xFF, 0x5a ^ 0xFF, 0xda ^ 0xFF, 0x3a ^ 0xFF, 0xba ^ 0xFF, 0x7a ^ 0xFF, 0xfa ^ 0xFF,
        0x06 ^ 0xFF, 0x86 ^ 0xFF, 0x46 ^ 0xFF, 0xc6 ^ 0xFF, 0x26 ^ 0xFF, 0xa6 ^ 0xFF, 0x66 ^ 0xFF, 0xe6 ^ 0xFF,
        0x16 ^ 0xFF, 0x96 ^ 0xFF, 0x56 ^ 0xFF, 0xd6 ^ 0xFF, 0x36 ^ 0xFF, 0xb6 ^ 0xFF, 0x76 ^ 0xFF, 0xf6 ^ 0xFF,
        0x0e ^ 0xFF, 0x8e ^ 0xFF, 0x4e ^ 0xFF, 0xce ^ 0xFF, 0x2e ^ 0xFF, 0xae ^ 0xFF, 0x6e ^ 0xFF, 0xee ^ 0xFF,
        0x1e ^ 0xFF, 0x9e ^ 0xFF, 0x5e ^ 0xFF, 0xde ^ 0xFF, 0x3e ^ 0xFF, 0xbe ^ 0xFF, 0x7e ^ 0xFF, 0xfe ^ 0xFF,
        0x01 ^ 0xFF, 0x81 ^ 0xFF, 0x41 ^ 0xFF, 0xc1 ^ 0xFF, 0x21 ^ 0xFF, 0xa1 ^ 0xFF, 0x61 ^ 0xFF, 0xe1 ^ 0xFF,
        0x11 ^ 0xFF, 0x91 ^ 0xFF, 0x51 ^ 0xFF, 0xd1 ^ 0xFF, 0x31 ^ 0xFF, 0xb1 ^ 0xFF, 0x71 ^ 0xFF, 0xf1 ^ 0xFF,
        0x09 ^ 0xFF, 0x89 ^ 0xFF, 0x49 ^ 0xFF, 0xc9 ^ 0xFF, 0x29 ^ 0xFF, 0xa9 ^ 0xFF, 0x69 ^ 0xFF, 0xe9 ^ 0xFF,
        0x19 ^ 0xFF, 0x99 ^ 0xFF, 0x59 ^ 0xFF, 0xd9 ^ 0xFF, 0x39 ^ 0xFF, 0xb9 ^ 0xFF, 0x79 ^ 0xFF, 0xf9 ^ 0xFF,
        0x05 ^ 0xFF, 0x85 ^ 0xFF, 0x45 ^ 0xFF, 0xc5 ^ 0xFF, 0x25 ^ 0xFF, 0xa5 ^ 0xFF, 0x65 ^ 0xFF, 0xe5 ^ 0xFF,
        0x15 ^ 0xFF, 0x95 ^ 0xFF, 0x55 ^ 0xFF, 0xd5 ^ 0xFF, 0x35 ^ 0xFF, 0xb5 ^ 0xFF, 0x75 ^ 0xFF, 0xf5 ^ 0xFF,
        0x0d ^ 0xFF, 0x8d ^ 0xFF, 0x4d ^ 0xFF, 0xcd ^ 0xFF, 0x2d ^ 0xFF, 0xad ^ 0xFF, 0x6d ^ 0xFF, 0xed ^ 0xFF,
        0x1d ^ 0xFF, 0x9d ^ 0xFF, 0x5d ^ 0xFF, 0xdd ^ 0xFF, 0x3d ^ 0xFF, 0xbd ^ 0xFF, 0x7d ^ 0xFF, 0xfd ^ 0xFF,
        0x03 ^ 0xFF, 0x83 ^ 0xFF, 0x43 ^ 0xFF, 0xc3 ^ 0xFF, 0x23 ^ 0xFF, 0xa3 ^ 0xFF, 0x63 ^ 0xFF, 0xe3 ^ 0xFF,
        0x13 ^ 0xFF, 0x93 ^ 0xFF, 0x53 ^ 0xFF, 0xd3 ^ 0xFF, 0x33 ^ 0xFF, 0xb3 ^ 0xFF, 0x73 ^ 0xFF, 0xf3 ^ 0xFF,
        0x0b ^ 0xFF, 0x8b ^ 0xFF, 0x4b ^ 0xFF, 0xcb ^ 0xFF, 0x2b ^ 0xFF, 0xab ^ 0xFF, 0x6b ^ 0xFF, 0xeb ^ 0xFF,
        0x1b ^ 0xFF, 0x9b ^ 0xFF, 0x5b ^ 0xFF, 0xdb ^ 0xFF, 0x3b ^ 0xFF, 0xbb ^ 0xFF, 0x7b ^ 0xFF, 0xfb ^ 0xFF,
        0x07 ^ 0xFF, 0x87 ^ 0xFF, 0x47 ^ 0xFF, 0xc7 ^ 0xFF, 0x27 ^ 0xFF, 0xa7 ^ 0xFF, 0x67 ^ 0xFF, 0xe7 ^ 0xFF,
        0x17 ^ 0xFF, 0x97 ^ 0xFF, 0x57 ^ 0xFF, 0xd7 ^ 0xFF, 0x37 ^ 0xFF, 0xb7 ^ 0xFF, 0x77 ^ 0xFF, 0xf7 ^ 0xFF,
        0x0f ^ 0xFF, 0x8f ^ 0xFF, 0x4f ^ 0xFF, 0xcf ^ 0xFF, 0x2f ^ 0xFF, 0xaf ^ 0xFF, 0x6f ^ 0xFF, 0xef ^ 0xFF,
        0x1f ^ 0xFF, 0x9f ^ 0xFF, 0x5f ^ 0xFF, 0xdf ^ 0xFF, 0x3f ^ 0xFF, 0xbf ^ 0xFF, 0x7f ^ 0xFF, 0xff ^ 0xFF,
};

static inline void prepare_scanline(uint y) {
	static uint8_t scanbuf[FRAME_WIDTH / 8];
	
    memset(scanbuf, 0x00, 80);

    if(fb != NULL && y > FIRST_LINE && y < LAST_LINE)
    {
            uint32_t offset = ((y - FIRST_LINE) * STRIDE);

            for(int x = 0; x < STRIDE; x++)
                    scanbuf[x + 8] = table[fb[offset + x]];
    }

	uint32_t* tmdsbuf;
	queue_remove_blocking(&dvi0.q_tmds_free, &tmdsbuf);
	tmds_encode_1bpp((const uint32_t*)scanbuf, tmdsbuf, FRAME_WIDTH);
	queue_add_blocking(&dvi0.q_tmds_valid, &tmdsbuf);
}

void __not_in_flash("scanline_callback")scanline_callback() {
	static uint y = 0;
	prepare_scanline(y);
	y = (y + 1) % FRAME_HEIGHT;
}

void set_framebuffer(uint8_t *framebuffer)
{
    fb = framebuffer;
}

void video_init()
{
    //Set overclock
    vreg_set_voltage(VREG_VSEL);
	sleep_ms(10);
	set_sys_clock_khz(DVI_TIMING.bit_clk_khz, true);

    //Init DVI
    dvi0.timing = &DVI_TIMING;
	dvi0.ser_cfg = DVI_DEFAULT_SERIAL_CONFIG;
	dvi0.scanline_callback = scanline_callback;
	dvi_init(&dvi0, next_striped_spin_lock_num(), next_striped_spin_lock_num());

    dvi_register_irqs_this_core(&dvi0, DMA_IRQ_0);

    prepare_scanline(0);

    hw_set_bits(&bus_ctrl_hw->priority, BUSCTRL_BUS_PRIORITY_PROC0_BITS);

	dvi_start(&dvi0);

}